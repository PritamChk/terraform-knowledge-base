<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      /* Dropdown transition */
      #country_list {
        transition: all 0.2s;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 min-h-screen flex items-center justify-center p-4 font-sans"
  >
    <form
      action="/start_quiz"
      method="POST"
      class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-4xl border-2 border-gray-300 relative"
    >
      <h1 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">
        Quiz Setup | 1
      </h1>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="col-span-1">
          <label class="block text-xs font-bold text-gray-500 uppercase"
            >Name</label
          >
          <input
            required
            type="text"
            name="guest_name"
            placeholder="e.g. Pritam"
            class="w-full border-2 border-gray-300 rounded-xl px-3 py-2 focus:border-blue-500 outline-none"
          />
        </div>

        <div class="col-span-1 relative group">
          <label class="block text-xs font-bold text-gray-500 uppercase"
            >Country</label
          >

          <input
            type="hidden"
            name="country_code"
            id="country_code_input"
            required
          />

          <div class="relative">
            <input
              type="text"
              id="country_search"
              placeholder="Type to search..."
              autocomplete="off"
              class="w-full border-2 border-gray-300 rounded-xl px-3 py-2 focus:border-blue-500 outline-none"
              onfocus="showDropdown()"
              oninput="filterCountries()"
            />

            <div
              id="selected_flag"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 w-8 h-8 pointer-events-none flex items-center justify-center"
            ></div>
          </div>

          <ul
            id="country_list"
            class="hidden absolute z-50 bg-white border-2 border-gray-300 w-full max-h-60 overflow-y-auto rounded-xl mt-1 shadow-2xl"
          >
            <li class="p-2 text-xs text-gray-400 text-center">
              Loading countries...
            </li>
          </ul>
        </div>

        <div class="col-span-1">
          <label class="block text-xs font-bold text-gray-500 uppercase"
            >Duration (Hr : Min)</label
          >
          <div class="flex gap-2">
            <input
              type="number"
              name="hours"
              min="0"
              max="23"
              value="0"
              class="w-1/2 border-2 border-gray-300 rounded-xl px-2 py-2 text-center"
            />
            <input
              type="number"
              name="minutes"
              min="5"
              max="59"
              value="15"
              class="w-1/2 border-2 border-gray-300 rounded-xl px-2 py-2 text-center"
            />
          </div>
        </div>

        <div class="col-span-1">
          <label class="block text-xs font-bold text-gray-500 uppercase"
            >No. of Qus</label
          >
          <input
            type="number"
            id="num_questions"
            name="num_questions"
            min="1"
            value="10"
            class="w-full border-2 border-gray-300 rounded-xl px-3 py-2 text-center focus:border-blue-500 outline-none"
          />
          <p class="text-xs text-gray-400 text-center mt-1">
            Max: <span id="max_qus_display">Select Topic</span>
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="md:col-span-2">
          <h3 class="text-gray-600 font-bold mb-2">Available Topics</h3>
          <input type="hidden" name="topic_id" id="topic_id_input" required />

          <div
            class="grid grid-cols-3 gap-4 h-64 overflow-y-auto pr-2 content-start"
          >
            {% for topic in topics %}
            <div
              onclick="selectTopic(this, '{{ topic.id }}', {{ topic.question_count }})"
              class="topic-card cursor-pointer border-2 border-orange-200 bg-orange-50 rounded-xl p-4 hover:shadow-md transition flex flex-col items-center justify-center text-center h-24"
            >
              <span class="font-bold text-gray-700 text-sm"
                >{{ topic.name }}</span
              >
              <span class="text-xs text-gray-500 mt-1"
                >{{ topic.question_count }} Qs</span
              >
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="md:col-span-1 border-l-2 border-gray-200 pl-4">
          <h3 class="text-gray-600 font-bold mb-2">Top Leaderboard</h3>
          <div class="space-y-2 max-h-64 overflow-y-auto">
            {% for player in leaderboard %}
            <div
              class="flex items-center gap-2 text-sm bg-gray-50 p-2 rounded-lg border border-gray-200"
            >
              <div
                class="w-6 h-6 rounded-full {{ 'bg-pink-200 text-pink-600' if loop.index == 1 else 'bg-blue-100 text-blue-600' }} flex items-center justify-center text-xs font-bold"
              >
                {{ loop.index }}
              </div>
              <div class="flex-1 truncate">{{ player.name }}</div>
              <img
                src="https://flagsapi.com/{{ player.country }}/flat/24.png"
                alt="{{ player.country }}"
              />
              <span
                class="font-bold {{ 'text-green-600' if player.score >= 90 else 'text-blue-600' }}"
                >{{ player.score|int }}%</span
              >
            </div>
            {% else %}
            <div class="text-center text-gray-400 text-xs py-4">
              No records yet.
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="flex justify-between items-end border-t pt-6">
        <div class="w-1/3">
          <label class="block text-xs font-bold text-gray-500 uppercase"
            >Pass %</label
          >
          <input
            type="number"
            name="pass_percent"
            min="0"
            max="100"
            value="70"
            class="w-full border-2 border-gray-300 rounded-xl px-3 py-2 text-center focus:border-blue-500 outline-none"
          />
        </div>

        <button
          type="submit"
          class="bg-green-400 hover:bg-green-500 text-white text-lg font-bold py-3 px-10 rounded-2xl shadow-lg transform hover:-translate-y-1 transition"
        >
          Let's Begin
        </button>
      </div>
    </form>

    <script>
      // --- 1. DYNAMIC COUNTRY LOGIC ---
      let allCountries = [];
      const countryListEl = document.getElementById("country_list");
      const searchInput = document.getElementById("country_search");

      // Fetch countries from RestCountries API (Standard Data Source)
      fetch("https://restcountries.com/v3.1/all?fields=name,cca2")
        .then((res) => res.json())
        .then((data) => {
          // Sort alphabetically
          allCountries = data.sort((a, b) =>
            a.name.common.localeCompare(b.name.common)
          );
          renderCountries(allCountries);
        })
        .catch((err) => {
          countryListEl.innerHTML =
            '<li class="p-2 text-red-500 text-xs">Failed to load countries</li>';
        });

      function renderCountries(list) {
        countryListEl.innerHTML = "";
        if (list.length === 0) {
          countryListEl.innerHTML =
            '<li class="p-2 text-gray-400 text-xs text-center">No matches found</li>';
          return;
        }

        list.forEach((c) => {
          const li = document.createElement("li");
          li.className =
            "flex items-center gap-3 p-2 hover:bg-blue-50 cursor-pointer border-b last:border-0 transition";
          // On Click: Set values and hide list
          li.onclick = () => selectCountry(c.name.common, c.cca2);

          li.innerHTML = `
                    <img src="https://flagsapi.com/${c.cca2}/flat/24.png" alt="${c.cca2}" class="w-6 h-6 object-contain">
                    <span class="text-sm text-gray-700">${c.name.common}</span>
                `;
          countryListEl.appendChild(li);
        });
      }

      function filterCountries() {
        const query = searchInput.value.toLowerCase();
        const filtered = allCountries.filter((c) =>
          c.name.common.toLowerCase().includes(query)
        );
        renderCountries(filtered);
        showDropdown();
      }

      function selectCountry(name, code) {
        searchInput.value = name;
        document.getElementById("country_code_input").value = code;

        // Show Flag in Input
        document.getElementById(
          "selected_flag"
        ).innerHTML = `<img src="https://flagsapi.com/${code}/flat/32.png" class="rounded shadow-sm">`;

        hideDropdown();
      }

      // --- UI UTILS ---
      function showDropdown() {
        countryListEl.classList.remove("hidden");
      }

      function hideDropdown() {
        // Small delay to allow click event to register
        setTimeout(() => {
          countryListEl.classList.add("hidden");
        }, 200);
      }

      // Close dropdown if clicking outside
      document.addEventListener("click", function (e) {
        if (!document.querySelector(".group").contains(e.target)) {
          hideDropdown();
        }
      });

      // --- 2. TOPIC LOGIC ---
      function selectTopic(el, id, maxQ) {
        document.querySelectorAll(".topic-card").forEach((c) => {
          c.classList.remove("bg-green-200", "border-green-400");
          c.classList.add("bg-orange-50", "border-orange-200");
        });
        el.classList.remove("bg-orange-50", "border-orange-200");
        el.classList.add("bg-green-200", "border-green-400");

        document.getElementById("topic_id_input").value = id;

        const qInput = document.getElementById("num_questions");
        qInput.max = maxQ;
        document.getElementById("max_qus_display").innerText = maxQ;
        if (parseInt(qInput.value) > maxQ) qInput.value = maxQ;
      }
    </script>
  </body>
</html>
